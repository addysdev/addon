<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Recovery">

<resultMap id="recoveryVO" type="com.offact.addys.vo.recovery.RecoveryVO" >
  <result column="companyName"      property="companyName"  />
  <result column="collectCode"      property="collectCode"  />
  <result column="recoveryCode"          property="recoveryCode"  />
  <result column="groupId"      property="groupId"  />
  <result column="groupName"      property="groupName"  />
  <result column="recoveryClosingDate"      property="recoveryClosingDate"  />
  <result column="memo"     property="memo"  />
  <result column="memoCnt"          property="memoCnt"  />
  <result column="collectDateTime"          property="collectDateTime"  />
  <result column="collectUserId"           property="collectUserId"  />
  <result column="returnDateTime"           property="returnDateTime"  />
  <result column="returnUserId"           property="returnUserId"  />
  <result column="returnUserName"           property="returnUserName"  />
  <result column="completeUserId"           property="completeUserId"  />
  <result column="completeUserName"           property="completeUserName"  />
  <result column="completeDateTime"           property="completeDateTime"  />
  <result column="sendDateTime"          property="sendDateTime"  />
  <result column="sendUserId"           property="sendUserId"  />
  <result column="sendUserName"           property="sendUserName"  />
  <result column="receiveDateTime"           property="receiveDateTime"  />
  <result column="receiveUserId"           property="receiveUserId"  />
  <result column="receiveUserName"           property="receiveUserName"  />
  <result column="checkDateTime"           property="checkDateTime"  />
  <result column="checkUserId"           property="checkUserId"  />
  <result column="checkUserName"           property="checkUserName"  />
  <result column="recoveryState"           property="recoveryState"  />
  <result column="productCode"           property="productCode"  />
  <result column="productName"           property="productName"  />
  <result column="productPrice"           property="productPrice"  />
  <result column="stockDate"           property="stockDate"  />
  <result column="recoveryCnt"           property="recoveryCnt"  />
  <result column="stockCnt"           property="stockCnt"  />
  <result column="addCnt"           property="addCnt"  />  
  <result column="lossCnt"           property="lossCnt"  />
  <result column="etc"           property="etc"  />
  <result column="etcCnt"           property="etcCnt"  />
  <result column="recoveryResultCnt"           property="recoveryResultCnt"  />
  <result column="recoveryResultPrice"           property="recoveryResultPrice"  />
  <result column="recoveryMemo"           property="recoveryMemo"  />
  <result column="recoveryMemoCnt"           property="recoveryMemoCnt"  />
  <result column="recoveryYn"           property="recoveryYn"  />
  <result column="updateUserId"           property="updateUserId"  />
  <result column="updateUserName"           property="updateUserName"  />
  <result column="updateDateTime"           property="updateDateTime"  />
  <result column="waitCnt"           property="waitCnt"  />  
  <result column="sendCnt"           property="sendCnt"  />  
  <result column="reciveCnt"           property="reciveCnt"  />  
  <result column="checkCnt"           property="checkCnt"  />  
  <result column="collectState"           property="collectState"  />  
  <result column="collectStateView"           property="collectStateView"  />  
</resultMap>


<select id="getCollectPageList"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

    Select T4.collectStateView,
         T4.collectState,
         T4.collectCode,
         sum(T4.waitCnt) as waitCnt,
         sum(T4.sendCnt) as sendCnt,
         sum(T4.reciveCnt) as reciveCnt,
         sum(T4.checkCnt) as checkCnt,
         T4.recoveryClosingDate,
         T4.collectDateTime,
         T4.memo
    From (
          Select T3.codeName as collectStateView ,
                 T1.collectState,
                 T1.collectCode,
                 Case When T2.recoveryState = '01' Then 1 Else 0 End waitCnt,
                 Case When T2.recoveryState = '02' Then 1 Else 0 End sendCnt,
                 Case When T2.recoveryState = '03' Then 1 Else 0 End reciveCnt,
                 Case When T2.recoveryState = '04' Then 1 Else 0 End checkCnt,
                 T1.recoveryClosingDate,
                 DATE_FORMAT(T1.collectDateTime, '%Y-%m-%d') as collectDateTime,
                 T1.memo
            From adCollect T1
                 Left Join adRecovery T2 On T1.collectCode=T2.collectCode
                 Left Join ofCode T3 On T1.collectState = T3.codeId and T3.codegroupId = 'RE01'
           Where T1.deletedYn='N'
                 AND T1.collectDateTime between concat(#{start_recoveryDate},' 00:00:00') and concat(#{end_recoveryDate},' 23:59:59')
             <if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000' and authId == '03'" >
           		AND T2.groupId = #{con_groupId}
             </if>
             <if test="con_collectState != null and con_collectState != ''" >
           		 AND T1.collectState = #{con_collectState}
             </if>
           ) As T4
   Group by T4.collectStateView,
  			T4.collectState,
           	T4.collectCode,
        	T4.recoveryClosingDate,
          	T4.collectDateTime
   LIMIT ${page_limit_val1} , ${page_limit_val2}
		
</select>

<select id="getCollectCnt" resultType="int">
	SELECT count(*) AS TOT_COUNT
		From (
  			      Select T4.collectStateView,
         				 T4.collectState,
         				 T4.collectCode,
         				 sum(T4.waitCnt),
         				 sum(T4.sendCnt),
         				 sum(T4.reciveCnt),
         				 sum(T4.checkCnt),
         				 T4.recoveryClosingDate,
         				 T4.collectDateTime,
         				 T4.memo
    			  	From (
          				  Select T3.codeName as collectStateView ,
                 				 T1.collectState,
                				 T1.collectCode,
               				     Case When T2.recoveryState = '01' Then 1 Else 0 End waitCnt,
                 				 Case When T2.recoveryState = '02' Then 1 Else 0 End sendCnt,
                 				 Case When T2.recoveryState = '03' Then 1 Else 0 End reciveCnt,
                 				 Case When T2.recoveryState = '04' Then 1 Else 0 End checkCnt,
                 				 T1.recoveryClosingDate,
                 				 DATE_FORMAT(T1.collectDateTime, '%Y-%m-%d') as collectDateTime,
                 				 T1.memo
            				From adCollect T1
                 				 Left Join adRecovery T2 On T1.collectCode=T2.collectCode
                 				 Left Join ofCode T3 On T1.collectState = T3.codeId and T3.codegroupId = 'RE01'
          			 Where T1.deletedYn='N'
                 		   AND T1.collectDateTime between concat(#{start_recoveryDate},' 00:00:00') and concat(#{end_recoveryDate},' 23:59:59')
           			    <if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000' and authId == '03'" >
           				   AND T2.groupId = #{con_groupId}
            		   </if>             	
             		   <if test="con_collectState != null and con_collectState != ''" >
           		 		   AND T1.collectState = #{con_collectState}
             		  </if>
           		) As T4
   		Group by T4.collectStateView,
  			T4.collectState,
           	T4.collectCode,
        	T4.recoveryClosingDate,
          	T4.collectDateTime
		) As TOT
			           
</select>

<select id="getRecoveryList"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

  Select T4.codeName as recoveryStateView ,
         T1.recoveryState,
         T1.recoveryCode,
         T2.recoveryClosingDate,
         DATE_FORMAT(T2.collectDateTime, '%Y-%m-%d') as collectDateTime,
         T1.groupId,
         T3.groupName,
         0 as recoveryResultCnt,
         0 as recoveryResultPrice
    From adRecovery T1
         Left Join adCollect T2 On T1.collectCode=T2.collectCode
         Left Join ofGroup T3 On T1.groupId = T3.groupId
         Left Join ofCode T4 On T1.recoveryState = T4.codeId and T4.codegroupId = 'RE02'
   Where T2.deletedYn='N'
         AND T1.collectCode = #{collectCode}
           <if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="con_recoveryState != null and con_recoveryState != ''" >
           		AND T1.recoveryState = #{con_recoveryState}
           </if>
   Group by T4.codeName,
  			T1.recoveryState,
         	T1.recoveryCode,
        	T2.recoveryClosingDate,
         	T2.collectDateTime,
         	T1.groupId,
         	T3.groupName
		
</select>


<select id="getRecoveryPageList"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

  Select T4.codeName as recoveryStateView ,
         T1.recoveryState,
         T1.recoveryCode,
         T2.recoveryClosingDate,
         DATE_FORMAT(T2.collectDateTime, '%Y-%m-%d') as collectDateTime,
         T1.groupId,
         T3.groupName,
         0 as recoveryResultCnt,
         0 as recoveryResultPrice
    From adRecovery T1
         Left Join adCollect T2 On T1.collectCode=T2.collectCode
         Left Join ofGroup T3 On T1.groupId = T3.groupId
         Left Join ofCode T4 On T1.recoveryState = T4.codeId and T4.codegroupId = 'RE02'
   Where T2.deletedYn='N'
           <if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="recoveryState != null and recoveryState != ''" >
           		AND T1.recoveryState = #{con_recoveryState}
           </if>
   Group by T4.codeName,
  			T1.recoveryState,
         	T1.recoveryCode,
        	T2.recoveryClosingDate,
         	T2.collectDateTime,
         	T1.groupId,
         	T3.groupName
	 LIMIT ${page_limit_val1} , ${page_limit_val2}
		
</select>

<select id="getRecoveryCnt" resultType="int">
	SELECT count(*) AS TOT_COUNT
		From (
  			  Select T4.codeName as recoveryStateView ,
         	  		 T1.recoveryState,
         	  		 T1.recoveryCode,
         	  		 T2.recoveryClosingDate,
         	 		 DATE_FORMAT(T2.collectDateTime, '%Y-%m-%d') as collectDateTime,
         	  		 T1.groupId,
         	  		 T3.groupName,
         	  		 0 as recoveryResultCnt,
         	  		 0 as recoveryResultPrice
    		 	From adRecovery T1
         			 Left Join adCollect T2 On T1.collectCode=T2.collectCode
         			 Left Join ofGroup T3 On T1.groupId = T3.groupId
         			 Left Join ofCode T4 On T1.recoveryState = T4.codeId and T4.codegroupId = 'RE02'
   				Where T2.deletedYn='N'
     	   		<if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           				AND T1.groupId = #{con_groupId}
          		</if>
           		<if test="recoveryState != null and recoveryState != ''" >
           				AND T1.recoveryState = #{con_recoveryState}
          		</if>
         		Group by T4.codeName,
  						 T1.recoveryState,
         				 T1.recoveryCode,
        				 T2.recoveryClosingDate,
         				 T2.collectDateTime,
         				 T1.groupId,
         				 T3.groupName
		) As TOT
			           
</select>

<select id="getRecoveryDetail"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

  Select T1.recoveryCode,
         T1.groupId,
         T3.groupName,
         T1.recoveryState,
         DATE_FORMAT(T2.collectDateTime,'%Y-%m-%d') as collectDateTime,  
         T2.collectUserId,
         T4.userName as collectUserName,
         T2.recoveryClosingDate,
         T2.memo,
         count(T5.idx) as memoCnt
    From adRecovery T1
         Left Join adCollect T2 On T1.collectCode=T2.collectCode
         Left Join ofGroup T3 On T1.groupId=T3.groupId
         Left Join ofUser T4 On T2.collectUserId=T4.userId
         Left Join adComment T5 On T1.recoveryCode = T5.orderCode And T5.commentCategory='05'
    Where T1.recoveryCode = #{recoveryCode}
    
</select>

<select id="getRecoveryDetailList"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

  Select T1.recoveryCode,
         T6.companyName,
         T1.productCode,
         T5.productName,
         T1.stockDate,
         T1.stockCnt,
         T1.recoveryCnt,
         T1.recoveryResultCnt,
         T1.addCnt,
         T1.lossCnt,
         T5.productPrice,
         T1.recoveryYn,
         T1.etc,
         (select count(idx) from adComment T7 Where T1.recoveryCode = T7.orderCode  And T1.productCode=T7.productCode And T7.commentCategory='06') as etcCnt,
         T2.recoveryState
    From adRecoveryDetail T1
         Left Join adRecovery T2 On T1.recoveryCode=T2.recoveryCode
         Left Join adCollect T3 On T2.collectCode=T3.collectCode
         Left Join ofGroup T4 On T2.groupId = T4.groupId
         Left Join adProductMaster T5 On T1.productCode = T5.productCode
         Left Join adCompany T6 On T5.companyCode = T6.companyCode
    Where T3.deletedYn='N' And T1.recoveryCode = #{recoveryCode}
    Order by T1.productCode asc
</select>

<update id="updateRecovery"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
		update adRecovery
			set
				sendUserId = #{sendUserId}
               ,recoveryDateTime = now()
               ,recoveryState = '02'
		where recoveryCode = #{recoveryCode}
		                        
</update>

<insert id="collectInsert"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

insert into adCollect (
		 collectCode
		,recoveryClosingDate
        ,collectUserId
        ,collectDateTime 
        ,collectState
        ,deletedYn
        ,memo
		)values(
				 #{collectCode}
				 , #{recoveryClosingDate}
	  			, #{collectUserId}
	  			, now()
	  			, #{collectState}
	  			,'N'
                ,#{memo}
		)
		                        
</insert>

<insert id="recoveryInsert"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

insert into adRecovery (
		recoveryCode
		,collectCode
        ,groupId
        ,recoveryState
		)values(
				 #{recoveryCode}
				 , #{collectCode}
	  			, #{groupId}
	  			, #{recoveryState}
		)
		                        
</insert>


<insert id="recoveryDetailInsert"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
		
insert into adRecoveryDetail (recoveryCode
        					 ,productCode
        					 ,createUserId
        				 	 ,createDateTime
        					 ,deletedYn
							 )values(
							 #{recoveryCode}
				 			 ,#{productCode}
         					 ,#{createUserId}
	  			             ,now()
	  			             ,'N'
							 )
		                        
</insert>


<update id="recoveryProcUpdate"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
		update adRecovery 
			 set sendUserId  = #{sendUserId}
        		,sendDateTime = now()
        		,recoveryState = #{recoveryState}
		where recoveryCode = #{recoveryCode}
		                        
</update>

<update id="recoveryDetailProcUpdate"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
	
		update adRecoveryDetail 
			set  recoveryCnt = #{recoveryCnt}
        		,addCnt = #{addCnt}
				,lossCnt = #{lossCnt}
         		,etc = #{etc}
			    ,updateUserId = #{updateUserId}
            	,updateDateTime = now()
		where recoveryCode = #{recoveryCode}
		  And productCode =  #{productCode}
		                        
</update>

<update id="recoveryCompleteUpdate"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
		update adRecovery 
			set completeUserId  = #{completeUserId}
        		,completeDateTime = now()
        		,recoveryState = #{recoveryState}
		where recoveryCode = #{recoveryCode}
		                        
</update>

<update id="recoveryCompleteDetailProcUpdate"  parameterType="com.offact.addys.vo.recovery.RecoveryVO" >
	
		update adRecoveryDetail 
			set recoveryResultCnt = #{recoveryResultCnt}
			    ,recoveryYn='Y'
			    ,updateUserId = #{updateUserId}
            	,updateDateTime = now()
		where recoveryCode = #{recoveryCode}
		  And productCode =  #{productCode}
		                        
</update>

<select id="getCollectCode"  resultMap="recoveryVO" parameterType="com.offact.addys.vo.recovery.RecoveryVO" >

Select concat(right(#{collectCode},6),T3.recoveryCode) As recoveryCode, 
       concat (#{collectCode},T3.recoveryCode) As collectCode 
  From (
  Select Case When T2.collectCodeNo <![CDATA[<]]> 10 Then concat('00',T2.collectCodeNo) 
              When T2.collectCodeNo <![CDATA[>=]]> 10 And T2.collectCodeNo  <![CDATA[<]]>  99  Then concat('0',T2.collectCodeNo) 
              Else T2.collectCodeNo End recoveryCode
    From(
          Select (cast(right(T1.collectCode,3) As unsigned)+1) As collectCodeNo 
            From (
                  Select ifnull(max(collectCode),concat(#{collectCode},'000')) As collectCode 
                    From adCollect where left(collectCode,7)=#{collectCode} ) As T1 
    ) As T2
  ) As T3

    
</select>

</mapper>
