<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="As">

<resultMap id="asListVO" type="com.offact.addys.vo.smart.AsVO" >
  <result column="asNo"              property="asNo"  />
  <result column="groupId"            property="groupId"  />
 <result column="groupName"            property="groupName"  />
  <result column="customerKey"      	   property="customerKey"  />
  <result column="customerName"       	   property="customerName"  />
  <result column="productCode"              property="productCode"  />
  <result column="productName"              property="productName"  />
  <result column="group1Id"            property="group1Id"  />
  <result column="group1Name"            property="group1Name"  />
  <result column="asCategory"                property="asCategory"  />
  <result column="asCode"   property="asCode"  />
  <result column="asDetail"   property="asDetail"  />
  <result column="asImage"   property="asImage"  />
  <result column="asState"   property="asState"  />
  <result column="asStartUserId"   property="asStartUserId"  />
  <result column="asStartDateTime"   property="asStartDateTime"  />
  <result column="asRequestUserId"   property="asRequestUserId"  />
  <result column="asRequestDateTime"   property="asRequestDateTime"  />
  <result column="asResponseUserId"   property="asResponseUserId"  />
  <result column="asResponseDateTime"   property="asResponseDateTime"  />
  <result column="asCompleteUserId"   property="asCompleteUserId"  />
  <result column="asCompleteDateTime"   property="asCompleteDateTime"  />
  <result column="asTargetDate"   property="asTargetDate"  />
  <result column="asResult"   property="asResult"  />
  <result column="receiveName"   property="receiveName"  />
  <result column="receiveTelNo"   property="receiveTelNo"  />
  <result column="receiveType"   property="receiveType"  />
  <result column="receiveAddress"   property="receiveAddress"  />
  <result column="receiveAddressDetail"   property="receiveAddressDetail"  />
  <result column="receivePost"   property="receivePost"  />
  <result column="customerRequest"   property="customerRequest"  />
  <result column="purchaseDate"   property="purchaseDate"  />
  <result column="receiptImage"   property="receiptImage"  />
  <result column="Memo"   property="Memo"  />
  <result column="asTransferNo"   property="asTransferNo"  />
  <result column="receiveTransferNo"   property="receiveTransferNo"  />
</resultMap>

<select id="getAsPageList"  resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >
        SELECT T1.asNo
			  ,T1.groupId
			  ,T2.groupName
			  ,T1.customerKey
			  ,T1.customerName 
			  ,T1.productCode
			  ,T4.productName
			  ,T4.group1
			  ,T4.group1Name
			  ,T1.asCategory
			  ,T1.asCode
			  ,T1.asDetail
			  ,T1.asImage
			  ,T1.asState
			  ,DATE_FORMAT(T1.asStartDateTime, '%Y-%m-%d') as asStartDateTime
			  ,Case When ifnull(T1.asTargetDate,'') = '' Then '' Else DATE_FORMAT(T1.asTargetDate, '%Y-%m-%d') End asTargetDate
			  ,ifnull(T1.asStartUserId,'') as asStartUserId
			  ,ifnull(T3.userName,'') as asStartUserName
          FROM smAs T1
          	   Left Join ofGroup T2 On T1.groupId=T2.groupId
			   Left Join ofUser T3 On T1.asStartUserId=T3.userId
			   Left Join adProductMaster T4 On T1.productCode=T4.productCode
         WHERE T1.asStartDateTime between concat(#{start_asDate},' 00:00:00') and concat(#{end_asDate},' 23:59:59')
         	<if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="searchValue != null and searchValue != ''" >
             <choose>
               <when test="searchGubun.equals('01')">
           AND T1.customerKey  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
               <when test="searchGubun.equals('02')">
           AND T1.customerName  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
             </choose>
           </if>
         ORDER BY asStartDateTime desc
 LIMIT ${page_limit_val1} , ${page_limit_val2}
</select>

<select id="getAsCnt" resultType="int">
	SELECT count(*) AS TOT_COUNT
  		FROM smAs T1
          	   Left Join ofGroup T2 On T1.groupId=T2.groupId
			   Left Join ofUser T3 On T1.asStartUserId=T3.userId
			   Left Join adProductMaster T4 On T1.productCode=T4.productCode
         WHERE T1.asStartDateTime between concat(#{start_asDate},' 00:00:00') and concat(#{end_asDate},' 23:59:59')
         	<if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="searchValue != null and searchValue != ''" >
             <choose>
               <when test="searchGubun.equals('01')">
           AND T1.customerKey  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
               <when test="searchGubun.equals('02')">
           AND T1.customerName  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
             </choose>
           </if>
</select>

<select id="getAsDetail" resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >

		SELECT T1.asNo
		      ,T1.groupId
			  ,T2.groupName
			  ,T1.customerKey
			  ,T1.customerName 
			  ,T1.productCode
			  ,T4.productName
			  ,T4.group1
			  ,T4.group1Name
			  ,T1.asCategory
			  ,T1.asCode
			  ,T1.asDetail
			  ,T1.asImage
			  ,T1.asState
			  ,DATE_FORMAT(T1.asStartDateTime, '%Y-%m-%d') as asStartDateTime
			  ,Case When ifnull(T1.asTargetDate,'') = '' Then '' Else DATE_FORMAT(T1.asTargetDate, '%Y-%m-%d') End asTargetDate
			  ,ifnull(T1.asStartUserId,'') as asStartUserId
			  ,ifnull(T3.userName,'') as asStartUserName
			  ,ifnull(T1.asResult,'') as asResult
			  ,ifnull(T1.asResultDateTime,'') as asResultDateTime
			  ,T1.receiveName
			  ,T1.receiveTelNo
			  ,T1.receiveType
			  ,T1.receiveAddress
			  ,T1.receiveAddressDetail
			  ,T1.receivePost
			  ,T1.customerRequest
			  ,T1.purchaseDate
			  ,T1.receiptImage
			  ,T1.Memo
			  ,T1.receiveTransferNo
          FROM smAs T1
			   Left Join ofGroup T2 On T1.groupId=T2.groupId
			   Left Join ofUser T3 On T1.asStartUserId=T3.userId
			   Left Join adProductMaster T4 On T1.productCode=T4.productCode  
		 Where T1.asNo = #{asNo}
		 
</select>

<update id="asStateUpdate" parameterType="com.offact.addys.vo.smart.AsVO" >
        Update smAs
       		Set
  				asState = #{asState}
 		Where asNo = #{asNo}
</update>

<insert id="asResultInsert" parameterType="com.offact.addys.vo.smart.AsVO" >
  	Insert into smAsResult( 
        	 asNo
            ,userId
            ,groupId
            ,asResult 
            ,asResultDateTime
            )
        Values (
              #{asNo}
	  		, #{userId}
	  		, #{groupId}
	  		, #{asResult}
	  		, now()
	  		)
	  		
</insert>

<select id="getAsReply" resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >

		SELECT T1.idx
		      ,T1.userId
		      ,T2.userName
		      ,DATE_FORMAT(T1.asHistoryDateTime, '%Y-%m-%d %T') as asHistoryDateTime
			  ,T1.asHistory
          FROM smAsHistory T1
               Left Join ofUser T2 on T1.userId=T2.userId
		 Where T1.asNo = #{asNo}
		 order by asHistoryDateTime desc
</select>

<insert id="regiReplyInsert" parameterType="com.offact.addys.vo.smart.AsVO" >
  	
  	Insert into smAsHistory( 
        	 userId
            ,groupId
            ,asHistory
            ,asHistoryDateTime
            ,asNo
            )
        Values (
	  		  #{userId}
	  		, #{groupId}
	  		, #{asHistory}
	  		, now()
	  		, #{asNo}
	  		)
</insert>

</mapper>
