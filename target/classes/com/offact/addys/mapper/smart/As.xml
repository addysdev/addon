<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="As">

<resultMap id="asListVO" type="com.offact.addys.vo.smart.AsVO" >
  <result column="idx"              property="idx"  />
  <result column="groupId"            property="groupId"  />
  <result column="customerKey"      	   property="customerKey"  />
  <result column="customerId"       	   property="customerId"  />
  <result column="customerName"       	   property="customerName"  />
  <result column="asState"              property="asState"  />
  <result column="as"                property="as"  />
  <result column="asDateTime"   property="asDateTime"  />
  <result column="userId"   property="userId"  />
  <result column="userName"   property="userName"  />
  <result column="asResult"   property="asResult"  />
  <result column="asResultDateTime"   property="asResultDateTime"  />
  <result column="stateUpdateUserId"   property="stateUpdateUserId"  />
  <result column="stateUpdateUserName"   property="stateUpdateUserName"  />
  <result column="stateUpdateDateTime"   property="stateUpdateDateTime"  />
</resultMap>

<select id="getAsPageList"  resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >
        SELECT T1.idx
			  ,T1.groupId
			  ,T2.groupName
			  ,T1.customerKey
			  ,T3.customerId   
			  ,T3.customerName 
			  ,DATE_FORMAT(T1.asDateTime, '%Y-%m-%d %T') as asDateTime
			  ,Case When T1.asState = '03' Then 'AS완료' Else
			  		(Case When T1.asState = '02' Then '처리중' Else 'AS접수' End)
			  		End asState
			  ,T1.as
			  ,Case When ifnull(T4.asResultDateTime,'') = '' Then '' Else DATE_FORMAT(T4.asResultDateTime, '%Y-%m-%d %T') End asResultDateTime
			  ,ifnull(T4.userId,'') as userId
			  ,ifnull(T5.userName,'') as userName
          FROM smAs T1
          	   Left Join ofGroup T2 On T1.groupId=T2.groupId
			   Left Join smCustomer T3 On T1.customerKey=T3.customerKey
			   Left Join smAsResult T4 On T1.idx=T4.idx
			   Left Join ofUser T5 On T4.userId=T5.userId
         WHERE T1.asDateTime between concat(#{start_asDate},' 00:00:00') and concat(#{end_asDate},' 23:59:59')
         	<if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="searchValue != null and searchValue != ''" >
             <choose>
               <when test="searchGubun.equals('01')">
           AND T1.customerKey  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
               <when test="searchGubun.equals('02')">
           AND T3.customerName  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
             </choose>
           </if>
         ORDER BY asDateTime desc
 LIMIT ${page_limit_val1} , ${page_limit_val2}
</select>

<select id="getAsCnt" resultType="int">
	SELECT count(*) AS TOT_COUNT
  		FROM smAs T1
          	   Left Join ofGroup T2 On T1.groupId=T2.groupId
			   Left Join smCustomer T3 On T1.customerKey=T3.customerKey
         WHERE T1.asDateTime between concat(#{start_asDate},' 00:00:00') and concat(#{end_asDate},' 23:59:59')
         	<if test="con_groupId != null and con_groupId != '' and con_groupId != 'G00000'" >
           		AND T1.groupId = #{con_groupId}
           </if>
           <if test="searchValue != null and searchValue != ''" >
             <choose>
               <when test="searchGubun.equals('01')">
           AND T1.customerKey  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
               <when test="searchGubun.equals('02')">
           AND T3.customerName  LIKE CONCAT('%', #{searchValue}, '%')
               </when>
             </choose>
           </if>
</select>

<select id="getAsDetail" resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >

		SELECT T1.idx
		      ,T1.customerKey
			  ,T2.customerId   
			  ,T2.customerName  
			  ,T1.asState
			  ,T1.as
			  ,T1.asDateTime
			  ,ifnull(T3.userId,'') as userId
			  ,ifnull(T4.userName,'') as userName
			  ,ifnull(T3.asResult,'') as asResult
			  ,ifnull(T3.asResultDateTime,'') as asResultDateTime
			  ,ifnull(T1.stateUpdateUserId,'') as stateUpdateUserId
			  ,ifnull(T5.userName,'') as stateUpdateUserName
			  ,ifnull(T1.stateUpdateDateTime,'') as stateUpdateDateTime
          FROM smAs T1
			   Left Join smCustomer T2 On T1.customerKey=T2.customerKey
			   Left Join smAsResult T3 On T1.idx=T3.idx
			   Left Join ofUser T4 On T3.userId=T4.userId
			   Left Join ofUser T5 On T1.stateUpdateUserId=T5.userId	   	     
		 Where T1.idx = #{idx}
</select>

<update id="asStateUpdate" parameterType="com.offact.addys.vo.smart.AsVO" >
        Update smAs
       		Set
  				asState = #{asState}
  				,stateUpdateUserId = #{stateUpdateUserId}
  				,stateUpdateDateTime = now()
 		Where idx = #{idx}
</update>

<insert id="asResultInsert" parameterType="com.offact.addys.vo.smart.AsVO" >
  	Insert into smAsResult( 
        	 idx
            ,userId
            ,groupId
            ,asResult 
            ,asResultDateTime
            )
        Values (
              #{idx}
	  		, #{userId}
	  		, #{groupId}
	  		, #{asResult}
	  		, now()
	  		)
	  		
</insert>

<select id="getAsReply" resultMap="asListVO" parameterType="com.offact.addys.vo.smart.AsVO" >

		SELECT T1.idx
		      ,T1.userId
		      ,T2.userName
		      ,DATE_FORMAT(T1.asHistoryDateTime, '%Y-%m-%d %T') as asHistoryDateTime
			  ,T1.asHistory
          FROM smAsHistory T1
               Left Join ofUser T2 on T1.userId=T2.userId
		 Where T1.upidx = #{upidx}
		 order by asHistoryDateTime desc
</select>

<insert id="regiReplyInsert" parameterType="com.offact.addys.vo.smart.AsVO" >
  	
  	Insert into smAsHistory( 
        	 userId
            ,groupId
            ,asHistory
            ,asHistoryDateTime
            ,upidx
            )
        Values (
	  		  #{userId}
	  		, #{groupId}
	  		, #{asHistory}
	  		, now()
	  		, #{upidx}
	  		)
</insert>

</mapper>
